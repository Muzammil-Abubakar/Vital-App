name: Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          # Using latest stable to ensure Dart 3.9.2+ support
      
      - name: Debug - Print environment info
        run: |
          echo "=== Environment Information ==="
          echo "Flutter version:"
          flutter --version
          echo ""
          echo "Dart version:"
          dart --version
          echo ""
          echo "Working directory:"
          pwd
          echo ""
          echo "Directory structure:"
          ls -la
          echo ""
          echo "Vital app directory:"
          ls -la vital_app/ || echo "vital_app directory not found"
      
      - name: Debug - Check pubspec.yaml
        working-directory: ./vital_app
        run: |
          echo "=== pubspec.yaml content ==="
          cat pubspec.yaml
          echo ""
          echo "=== SDK requirement ==="
          grep -A 2 "sdk:" pubspec.yaml || echo "SDK requirement not found"
          echo ""
          echo "=== Test files ==="
          find test -name "*.dart" -type f 2>/dev/null || echo "No test files found"
      
      - name: Get dependencies
        working-directory: ./vital_app
        run: |
          echo "=== Running flutter pub get ==="
          flutter pub get --verbose
          echo ""
          echo "=== Dependencies resolved ==="
          flutter pub deps
      
      - name: Run Flutter analyze
        working-directory: ./vital_app
        run: |
          echo "=== Running Flutter analyze ==="
          flutter analyze --verbose || {
            echo "Analysis failed. Full output:"
            flutter analyze
            exit 1
          }
          echo "Analysis passed"
      
      - name: Run tests
        working-directory: ./vital_app
        run: |
          echo "=== Running Flutter tests ==="
          echo "Test directory contents:"
          ls -la test/ 2>/dev/null || echo "Test directory not found or empty"
          echo ""
          flutter test --coverage --verbose || {
            echo "Tests failed. Full output:"
            flutter test --coverage
            echo ""
            echo "=== Test summary ==="
            exit 1
          }
          echo "All tests passed"
      
      - name: Generate coverage report
        working-directory: ./vital_app
        run: |
          echo "=== Coverage Report Generation ==="
          if [ -f coverage/lcov.info ]; then
            echo "Coverage report found at: coverage/lcov.info"
            echo "Coverage file size:"
            ls -lh coverage/lcov.info
            echo ""
            echo "Coverage summary (first 50 lines):"
            head -50 coverage/lcov.info || echo "Could not read coverage file"
          else
            echo "No coverage data found"
            echo "Checking coverage directory:"
            ls -la coverage/ 2>/dev/null || echo "Coverage directory does not exist"
          fi
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: vital_app/coverage/lcov.info
          retention-days: 30

