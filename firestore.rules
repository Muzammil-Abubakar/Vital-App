rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the document owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user exists in clinicians collection
    function isClinician() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/clinicians/$(request.auth.uid));
    }
    
    // Helper function to check if user exists in patients collection
    function isPatient() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/patients/$(request.auth.uid));
    }
    
    // ============================================
    // CLINICIANS COLLECTION
    // ============================================
    match /clinicians/{clinicianId} {
      // Allow read: Clinicians can read their own profile
      // Allow read: Patients can read clinician profiles (for appointment booking)
      // Allow read: Admins can read all clinician profiles
      allow read: if isAuthenticated();
      
      // Allow create: Only during sign-up, user must be creating their own document
      allow create: if isOwner(clinicianId) && 
                       request.resource.data.keys().hasAll(['name', 'age', 'email', 'createdAt']) &&
                       request.resource.data.name is string &&
                       request.resource.data.age is int &&
                       request.resource.data.email is string &&
                       request.resource.data.email == request.auth.token.email;
      
      // Allow update: Clinician can update their own profile (except verified status)
      // Admin (admin@vital.com) can update verified status
      allow update: if (isOwner(clinicianId) && 
                       request.resource.data.diff(resource.data).unchangedKeys().hasAll(['createdAt', 'verified'])) ||
                     (isAuthenticated() && 
                      request.auth.token.email == 'admin@vital.com' && 
                      request.resource.data.diff(resource.data).changedKeys().hasOnly(['verified', 'verifiedAt']));
      
      // Allow delete: Only the clinician can delete their own profile
      allow delete: if isOwner(clinicianId);
      
      // Clinician Documents Subcollection
      match /documents/{documentId} {
        // Clinicians can read their own documents
        // Admins (admin@vital.com) can read all clinician documents
        allow read: if isAuthenticated() && 
                     (isOwner(clinicianId) || request.auth.token.email == 'admin@vital.com');
        // Only clinicians can create their own documents during signup
        allow create: if isOwner(clinicianId);
        // No updates or deletes allowed
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // PATIENTS COLLECTION
    // ============================================
    match /patients/{patientId} {
      // Allow read: Patients can read their own profile
      // Allow read: Clinicians can read patient profiles (for medical records)
      allow read: if isAuthenticated() && (isOwner(patientId) || isClinician());
      
      // Allow create: Only during sign-up, user must be creating their own document
      allow create: if isOwner(patientId) && 
                       request.resource.data.keys().hasAll(['name', 'age', 'email', 'createdAt']) &&
                       request.resource.data.name is string &&
                       request.resource.data.age is int &&
                       request.resource.data.email is string &&
                       request.resource.data.email == request.auth.token.email;
      
      // Allow update: Patients can update their own profile, clinicians can update patient profiles
      allow update: if (isOwner(patientId) || isClinician()) && 
                       request.resource.data.diff(resource.data).unchangedKeys().hasAll(['createdAt']);
      
      // Allow delete: Only the patient can delete their own profile
      allow delete: if isOwner(patientId);
      
      // Health Data Subcollection
      match /health_data/{dateKey} {
        // Patients can read and write their own health data
        // Clinicians can read patient health data (for medical records)
        allow read: if isAuthenticated() && (isOwner(patientId) || isClinician());
        allow create, update: if isAuthenticated() && isOwner(patientId);
        allow delete: if isAuthenticated() && isOwner(patientId);
      }
      
      // Food Data Subcollection
      match /food_data/{dateKey} {
        // Patients can read and write their own food data
        // Clinicians can read patient food data (for medical records)
        allow read: if isAuthenticated() && (isOwner(patientId) || isClinician());
        allow create, update: if isAuthenticated() && isOwner(patientId);
        allow delete: if isAuthenticated() && isOwner(patientId);
      }
      
      // Exercise Data Subcollection
      match /exercise_data/{dateKey} {
        // Patients can read and write their own exercise data
        // Clinicians can read patient exercise data (for medical records)
        allow read: if isAuthenticated() && (isOwner(patientId) || isClinician());
        allow create, update: if isAuthenticated() && isOwner(patientId);
        allow delete: if isAuthenticated() && isOwner(patientId);
      }
      
      // Medical Documents Subcollection
      match /medical_documents/{documentId} {
        // Patients can read and write their own medical documents
        // Clinicians can read patient medical documents (for medical records)
        allow read: if isAuthenticated() && (isOwner(patientId) || isClinician());
        allow create: if isAuthenticated() && isOwner(patientId);
        allow update: if isAuthenticated() && isOwner(patientId);
        allow delete: if isAuthenticated() && isOwner(patientId);
      }
    }
    
    // ============================================
    // PRESCRIPTION REQUESTS COLLECTION
    // ============================================
    match /prescription_requests/{requestId} {
      // Patients can create requests
      allow create: if isAuthenticated() && 
                       isPatient() &&
                       request.resource.data.patientId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['patientId', 'patientName', 'patientEmail', 'clinicianId', 'clinicianName', 'status', 'createdAt', 'updatedAt']);
      
      // Patients can read their own requests
      // Clinicians can read requests made to them
      allow read: if isAuthenticated() && 
                    (resource.data.patientId == request.auth.uid ||
                     resource.data.clinicianId == request.auth.uid);
      
      // Only clinicians can update requests (to approve/reject)
      allow update: if isAuthenticated() && 
                      isClinician() &&
                      resource.data.clinicianId == request.auth.uid &&
                      request.resource.data.diff(resource.data).unchangedKeys().hasAll(['patientId', 'patientName', 'patientEmail', 'clinicianId', 'clinicianName', 'createdAt']) &&
                      request.resource.data.status in ['pending', 'approved', 'rejected'];
      
      // No deletes allowed (for audit trail)
      allow delete: if false;
    }
    
    // ============================================
    // OLD USERS COLLECTION (if you still have data there)
    // ============================================
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      // Subcollections
      match /{document=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

